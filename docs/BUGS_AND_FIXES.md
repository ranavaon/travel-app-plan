# באגים ופתרונות

מסמך זה מתעד באגים שנפתחו ומה נפתר (כולל הפתרון).

## כשאתה מדווח על באג (גם כאן בצ'אט)

1. **חובה – פתח Issue ב-GitHub:**  
   [לפתיחת Issue חדש](https://github.com/ranavon/travel-app-plan/issues/new/choose) → בחר "דיווח באג / Bug report" ומלא את השדות (תיאור, איך לשחזר, מצופה, בפועל).
2. **רק אחרי שיש Issue:** צור ענף `fix/...` מ-`development` (למשל `fix/issue-5-share-url`), בצע את התיקון בענף הזה בלבד, דחוף ופתח PR ל-`development`.
3. **אחרי המיזוג:** הוסף רשומה כאן עם קישור ל-Issue ולענף/PR.

בלי Issue – לא מתחילים תיקון. כל תיקון בענף נפרד. ראה [docs/WORKFLOW.md](WORKFLOW.md).

---

## תבנית לרישום באג

כל רשומה חייבת לכלול קישור ל-Issue ב-GitHub (כי לכל באג נפתח Issue לפני התיקון).

```markdown
### כותרת / מזהה
- **Issue:** #N (קישור ל-GitHub – חובה)
- **תיאור:** איפה ומה לא עבד
- **איך לשחזר:** (אם רלוונטי)
- **פתרון:** מה שונה בקוד (קבצים, לוגיקה)
- **ענף/PR:** `fix/...` ו-PR ל-`development`
```

---

## רשימת באגים שטופלו

### 1. תגובת API להוספת הוצאה (POST expenses)

- **תיאור:** ב-`POST /api/trips/:tripId/expenses` השימוש ב-`req.params.tripId` ישירות ב-INSERT ו-parsing של `amount` היו בעייתיים; התגובה לא תמיד תאמה לרישום ב-DB.
- **איך לשחזר:** שליחת POST עם `amount` כמחרוזת או ערך לא מספרי; השוואת האובייקט המוחזר לרשומה שנוצרה.
- **פתרון:** 
  - שימוש במשתנה `tripId` עקבי; המרת `amount` ל-`Number(amount) ?? 0` לפני ה-INSERT.
  - שליחת התגובה מתוך `toExpense(row)` אחרי קריאת הרשומה מה-DB.
- **קבצים:** `backend/src/index.ts`
- **ענף/PR:** `fix/expense-api-response` → PR ל-`development`

---

### 2. עדכון אופטימי להוספת הוצאה ומקום מסומן (פרונט)

- **תיאור:** כש-API פעיל, אחרי `addExpense` או `addPinnedPlace` הפריט לא הופיע מיד בממשק; המשתמש חיכה לתשובת השרת.
- **איך לשחזר:** הפעלת API, הוספת הוצאה או מקום מסומן – הפריט לא מופיע עד סיום הבקשה.
- **פתרון:** 
  - יצירת אובייקט אופטימי עם `generateId()`, הוספה מיידית ל-state.
  - שליחת הבקשה ל-API; בהצלחה – החלפת האובייקט האופטימי באובייקט מהשרת (עם ה-id האמיתי); בכשל – הסרת האובייקט האופטימי מהרשימה.
- **קבצים:** `frontend/src/context/TripContext.tsx`
- **ענף/PR:** `fix/optimistic-expenses-pinned-places` → PR ל-`development`

---

### 3. ייצוא טיול ל-TXT ו-PDF

- **תיאור:** כפתור "ייצא לטקסט" בלבד; לא הייתה אפשרות לייצא ל-PDF או לבחור פורמט.
- **איך לשחזר:** בדף טיול – לחיצה על ייצוא; רק טקסט.
- **פתרון:** 
  - כפתור "ייצא" שפותח דיאלוג עם אפשרויות TXT ו-PDF.
  - ייצוא PDF עם jsPDF, תמיכה ב-RTL ושם קובץ שמנקה תווים לא חוקיים (כולל תמיכה בעברית ב-`exportFileName`).
- **קבצים:** `frontend/src/pages/Trip.tsx`, תלות `jspdf`
- **ענף/PR:** `fix/export-txt-pdf` → PR ל-`development`

---

### 4. קישור שיתוף ב-localhost

- **תיאור:** כשמריצים באפליקציה ב-localhost, קישור השיתוף שהועתק ללוח היה עלול להשתמש ב-`origin` לא נכון (למשל https) או לא להתאים לכתובת שבה הפרונט רץ.
- **איך לשחזר:** הרצת פרונט על localhost, לחיצה על "שתף קישור" – הקישור המועתק לא תמיד עבד לפתיחה באותה מכונה.
- **פתרון:** 
  - חישוב `baseOrigin`: אם `hostname` הוא `localhost` או `127.0.0.1` – שימוש ב-`http://${window.location.host}`, אחרת `window.location.origin`.
  - בניית `shareUrl` עם `baseOrigin` כך שהקישור מתאים לסביבת הפיתוח.
- **קבצים:** `frontend/src/pages/Trip.tsx`
- **ענף/PR:** `fix/share-url-localhost` → PR ל-`development`
