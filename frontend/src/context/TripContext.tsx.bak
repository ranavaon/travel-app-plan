import {
  createContext,
  useContext,
  useState,
  useCallback,
  type ReactNode,
} from 'react';
import type { Trip } from '../types';
import { getTrips as getMockTrips } from '../data/mockData';

export type AddTripInput = {
  name: string;
  startDate: string;
  endDate: string;
  destination?: string;
};

export type UpdateTripInput = Partial<AddTripInput>;

type TripContextValue = {
  getTrips: () => Trip[];
  getTrip: (id: string) => Trip | undefined;
  getDays: (trip: Trip) => Day[];
  getActivitiesForDay: (tripId: string, dayIndex: number) => Activity[];
  getAccommodationForDay: (tripId: string, dayIndex: number) => Accommodation | undefined;
  getTrip: (id: string) => Trip | undefined;
  getDays: (trip: Trip) => Day[];
  getActivitiesForDay: (tripId: string, dayIndex: number) => Activity[];
  getAccommodationForDay: (tripId: string, dayIndex: number) => Accommodation | undefined;
  addTrip: (input: AddTripInput) => Trip;
  updateTrip: (id: string, partial: UpdateTripInput) => void;
  deleteTrip: (id: string) => void;
};

const TripContext = createContext<TripContextValue | null>(null);

function generateId(): string {
  return Date.now().toString(36) + Math.random().toString(36).slice(2);
}

function nowIso(): string {
  return new Date().toISOString();
}

export function TripProvider({ children }: { children: ReactNode }) {
  const [trips, setTrips] = useState<Trip[]>(() => getMockTrips());

  const getTrips = useCallback(() => trips, [trips]);

  const addTrip = useCallback((input: AddTripInput): Trip => {
    const id = generateId();
    const createdAt = nowIso();
    const updatedAt = createdAt;
    const newTrip: Trip = {
      id,
      userId: 'u1',
      name: input.name,
      startDate: input.startDate,
      endDate: input.endDate,
      destination: input.destination,
      createdAt,
      updatedAt,
    };
    setTrips((prev) => [...prev, newTrip]);
    return newTrip;
  }, []);

  const updateTrip = useCallback((id: string, partial: UpdateTripInput) => {
    setTrips((prev) =>
      prev.map((t) =>
        t.id === id
          ? {
              ...t,
              ...partial,
              updatedAt: nowIso(),
            }
          : t
      )
    );
  }, []);

  const deleteTrip = useCallback((id: string) => {
    setTrips((prev) => prev.filter((t) => t.id !== id));
  }, []);

  const value: TripContextValue = {
    getTrips,
    addTrip,
    updateTrip,
    deleteTrip,
  };

  return (
    <TripContext.Provider value={value}>{children}</TripContext.Provider>
  );
}

export function useTripData(): TripContextValue {
  const ctx = useContext(TripContext);
  if (!ctx) {
    throw new Error('useTripData must be used within TripProvider');
  }
  return ctx;
}
